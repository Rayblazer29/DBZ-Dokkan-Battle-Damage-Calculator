<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dokkan Damage Calculator</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <main class="app">
      <h1 class="title">Dokkan Damage Calculator</h1>
      <p class="subtitle">Enter stats to estimate damage taken!</p>
      <nav class="navboard" aria-label="Primary">
        <a class="nav-link is-active" href="index.html">Calculator</a>
        <a class="nav-link" href="evidence.html">Evidence</a>
        <a class="nav-link" href="devlog.html">Devlog</a>
      </nav>
      <p class="subtitle">
        You can find information/stats of enemies here:
        <a href="https://dokkaninfo.com/events/challenge" target="_blank" rel="noopener noreferrer">
          https://dokkaninfo.com/events/challenge
        </a>
      </p>
      <section class="calculator">
        <form id="calc-form" class="card">
          <section class="panel panel-ally">
            <h2>Your Character</h2>
            <div class="grid">
              <label>
                Type
                <select id="allyType">
                  <option value="AGL">AGL</option>
                  <option value="INT">INT</option>
                  <option value="PHY">PHY</option>
                  <option value="STR">STR</option>
                  <option value="TEQ">TEQ</option>
                </select>
              </label>

              <label>
                Class
                <select id="allyClass">
                  <option value="Super">Super</option>
                  <option value="Extreme">Extreme</option>
                </select>
              </label>

              <div class="grid-break" aria-hidden="true"></div>

              <label>
                Defense
                <input type="number" id="defense" min="0" step="1" value="200000" required>
              </label>

              <label>
                Defense Buff % (on hit)
                <input type="number" id="defBuff" min="0" step="1" value="0">
              </label>

              <label>
                Damage Reduction %
                <input type="number" id="damageReduction" min="0" step="1" value="0">
              </label>

              <div class="grid-break" aria-hidden="true"></div>

              <div class="toggle-field">
                <p class="toggle-label">Guard</p>
                <div class="toggle-button">
                  <input type="checkbox" id="passiveGuard">
                  <label for="passiveGuard" data-off="No Guard" data-on="Guard Active"></label>
                </div>
              </div>

              <div class="additional-dr">
                <input type="checkbox" id="additionalDrToggle" class="additional-dr-toggle">
                <label for="additionalDrToggle" class="additional-dr-label">Additional DR?</label>
                <div class="additional-dr-fields">
                  <label>
                    DR vs Normals %
                    <input type="number" id="drNormals" min="0" step="1" value="0">
                  </label>

                  <label>
                    DR vs Super Attacks %
                    <input type="number" id="drSupers" min="0" step="1" value="0">
                  </label>
                </div>
              </div>
            </div>
          </section>

          <section class="panel panel-enemy">
            <h2>Enemy Character</h2>
            <div class="grid">
              <label>
                Type
                <select id="enemyType">
                  <option value="AGL">AGL</option>
                  <option value="INT">INT</option>
                  <option value="PHY">PHY</option>
                  <option value="STR">STR</option>
                  <option value="TEQ">TEQ</option>
                </select>
              </label>

              <label>
                Class
                <select id="enemyClass">
                  <option value="Super">Super</option>
                  <option value="Extreme">Extreme</option>
                </select>
              </label>
              <details class="preset-dropdown">
                <summary>Presets</summary>
                <div class="preset-list">
                  <!-- Bio Broly Presets-->
                   <details class="preset-group">
                    <summary>ALF RZ Bio Broly</summary>
                    <div class="preset-group-list">
                      <button type="button" data-preset="ALF RZ Bio Broly">ALF RZ Bio Broly T1</button>
                      <button type="button" data-preset="ALF RZ Bio Broly Built">ALF RZ Bio Broly (Fully built)</button>
                    </div>
                  </details>
                  
                  <!-- Gamma 1 & 2 Presets-->
                  <details class="preset-group">
                    <summary>ALF RZ Gamma1&2</summary>
                    <div class="preset-group-list">
                      <button type = "button" data-preset="ALF RZ Gamma 2 (T2)">ALF RZ Gamma 2 (T2)</button>
                      <button type="button" data-preset="ALF RZ Gamma1&2 (T1)">ALF RZ Gamma1&2 (T1)</button>
                      <button type="button" data-preset="ALF RZ Gamma1&2 (T3)">ALF RZ Gamma1&2 (T3)</button>
                    </div>
                  </details>
                  <details class ="preset-group">
                    <summary>Festival of Battles</summary>
                    <div class="preset-group-list">
                      <button type="button" data-preset="FoB AGL Super Gogeta">FoB AGL Super Gogeta</button>
                      <button type="button" data-preset="FoB TEQ Super Vegito">FoB TEQ Super Vegito</button>

                    </div>
                  </details>
                </div>
              </details>

              <div class="grid-break" aria-hidden="true"></div>

              <label>
                Attack
                <input type="number" id="enemyAtk" min="0" step="1" value="300000" required>
              </label>

                <label>
                  Attack Buff % (On Super Attack)
                  <input type="number" id="enemyAtkBuff" min="0" step="1" value="0">
                </label>

                <label>
                  Super Attack Multiplier
                  <input type="number" id="saMultiplier" min="0" step="0.01" value="1" required>
                </label>

              <div class="grid-break" aria-hidden="true"></div>

              <div class="toggle-field">
                <p class="toggle-label">Crit</p>
                <div class="toggle-button toggle-button--crit">
                  <input type="checkbox" id="enemyCrit">
                  <label for="enemyCrit" data-off="No Crit" data-on="Crit"></label>
                </div>
              </div>

              <div class="external-atk">
                <input type="checkbox" id="externalAtkToggle" class="external-atk-toggle">
                <label for="externalAtkToggle" class="external-atk-label">External Attack Buffs?</label>
                <div class="external-atk-fields">
                  <label>
                    External ATK Buff %
                    <input type="number" id="externalAtkBuff" min="0" step="1" value="0">
                  </label>
                </div>
              </div>

            </div>
          </section>

          <section class="panel panel-modifiers">
            <h2>Other Modifiers</h2>
            <div class="grid">
              <label>
                ATK Down (SA) %
                <input type="number" id="atkDownSa" min="0" max="100" step="1" value="0">
              </label>

              <label>
                ATK Down (Item) %
                <input type="number" id="atkDownItem" min="0" max="100" step="1" value="0">
              </label>

              <label>
                ATK Down (Passive) %
                <input type="number" id="atkDownPassive" min="0" max="100" step="1" value="0">
              </label>

            </div>
          </section>

          <div class="actions">
            <button type="submit">Calculate</button>
            <button type="button" id="resetBtn">Reset</button>
          </div>
        </form>

        <section class="result card">
          <h2>Result</h2>
          <table class="result-table">
            <tr>
              <th>Damage taken from Super Attack:</th>
              <td id="superResult">0</td>
            </tr>
            <tr>
              <th>Damage taken from Normal Attack:</th>
              <td id="normalResult">0</td>
            </tr>
          </table>
        </section>
      </section>
    </main>

    <script>
      const form = document.getElementById("calc-form");
      const resetBtn = document.getElementById("resetBtn");
      const superResult = document.getElementById("superResult");
      const normalResult = document.getElementById("normalResult");
      const presetButtons = document.querySelectorAll(".preset-list button");

      const enemyPresets = {
        "ALF RZ Bio Broly": {
          enemyType: "PHY",
          enemyClass: "Extreme",
          enemyAtk: 2250000,
          enemyAtkBuff: 0,
          saMultiplier: 3.5,
          enemyCrit: false,
          externalAtkBuff: 0,
        },
        "ALF RZ Bio Broly Built": {
          enemyType: "PHY",
          enemyClass: "Extreme",
          enemyAtk: 2250000,
          enemyAtkBuff: 0,
          saMultiplier: 3.5,
          enemyCrit: false,
          externalAtkBuff: 200,
        },
        "ALF RZ Gamma 2 (T2)": {
          enemyType: "AGL",
          enemyClass: "Super",
          enemyAtk: 1400000,
          enemyAtkBuff: 50,
          saMultiplier: 3,
          enemyCrit: false,
          externalAtkBuff: 200,
        },
        "ALF RZ Gamma1&2 (T1)": {
          enemyType: "TEQ",
          enemyClass: "Super",
          enemyAtk: 1800000,
          enemyAtkBuff: 50,
          saMultiplier: 3.5,
          enemyCrit: false,
          externalAtkBuff: 0,
        },
        "ALF RZ Gamma1&2 (T3)": {
          enemyType: "TEQ",
          enemyClass: "Super",
          enemyAtk: 1800000,
          enemyAtkBuff: 50,
          saMultiplier: 3.5,
          enemyCrit: false,
          externalAtkBuff: 300,
        },
        "FoB AGL Super Gogeta": {
          enemyType: "AGL",
          enemyClass: "Super",
          enemyAtk: 7000000,
          enemyAtkBuff: 50,
          saMultiplier: 3.5,
          enemyCrit: false,
          externalAtkBuff: 0,
        },
        "FoB TEQ Super Vegito": {
          enemyType: "TEQ",
          enemyClass: "Super",
          enemyAtk: 7000000,
          enemyAtkBuff: 0,
          saMultiplier: 3.5,
          enemyCrit: false,
          externalAtkBuff: 0,
        },
      };

      const toDecimal = (value) => Math.max(0, Math.min(1, value / 100));

      const applyEnemyPreset = (presetName) => {
        const preset = enemyPresets[presetName];
        if (!preset) return;

        document.getElementById("enemyType").value = preset.enemyType;
        document.getElementById("enemyClass").value = preset.enemyClass;
        document.getElementById("enemyAtk").value = preset.enemyAtk;
        document.getElementById("enemyAtkBuff").value = preset.enemyAtkBuff;
        document.getElementById("saMultiplier").value = preset.saMultiplier;
        document.getElementById("enemyCrit").checked = preset.enemyCrit;
        document.getElementById("externalAtkBuff").value = preset.externalAtkBuff;
        document.getElementById("externalAtkToggle").checked = preset.externalAtkBuff > 0;
      };

      const getTypeAndGuardMultipliers = (classMatch, typeMatch, passiveGuard) => {
        if (passiveGuard) {
          return { typeMultiplier: 0.8, guardMultiplier: 0.5 };
        }

        const effectiveTypeMatch = typeMatch;

        let typeMultiplier = 1;
        if (classMatch === "same" && effectiveTypeMatch === "disadvantage") typeMultiplier = 1.25;
        if (classMatch === "opposite" && effectiveTypeMatch === "disadvantage") typeMultiplier = 1.5;
        if (classMatch === "same" && effectiveTypeMatch === "neutral") typeMultiplier = 1;
        if (classMatch === "opposite" && effectiveTypeMatch === "neutral") typeMultiplier = 1.15;
        if (classMatch === "same" && effectiveTypeMatch === "advantage") typeMultiplier = 0.9;
        if (classMatch === "opposite" && effectiveTypeMatch === "advantage") typeMultiplier = 1;

        let guardMultiplier = effectiveTypeMatch === "advantage" ? 0.5 : 1;
        if (passiveGuard) {
          guardMultiplier = 0.5;
        }

        return { typeMultiplier, guardMultiplier };
      };

      const calculateDamage = () => {
        const enemyAtk = Number(document.getElementById("enemyAtk").value);
        const saMultiplier = Number(document.getElementById("saMultiplier").value);
        const atkDownSa = toDecimal(Number(document.getElementById("atkDownSa").value));
        const atkDownItem = toDecimal(Number(document.getElementById("atkDownItem").value));
        const atkDownPassive = toDecimal(Number(document.getElementById("atkDownPassive").value));
        const damageReduction = toDecimal(Number(document.getElementById("damageReduction").value));
        const additionalDr = document.getElementById("additionalDrToggle").checked;
        const drNormals = additionalDr
          ? toDecimal(Number(document.getElementById("drNormals").value))
          : 0;
        const drSupers = additionalDr
          ? toDecimal(Number(document.getElementById("drSupers").value))
          : 0;
        const defense = Number(document.getElementById("defense").value);
        const defBuff = Math.max(0, Number(document.getElementById("defBuff").value) / 100);
        const atkBuff = Math.max(0, Number(document.getElementById("enemyAtkBuff").value) / 100);
        const externalAtk = document.getElementById("externalAtkToggle").checked
          ? Math.max(0, Number(document.getElementById("externalAtkBuff").value) / 100)
          : 0;
        const variance = 1.03;
        const allyType = document.getElementById("allyType").value;
        const enemyType = document.getElementById("enemyType").value;
        const allyClass = document.getElementById("allyClass").value;
        const enemyClass = document.getElementById("enemyClass").value;
        const passiveGuard = document.getElementById("passiveGuard").checked;
        //types
        const typeOrder = {
          AGL: "STR",
          STR: "PHY",
          PHY: "INT",
          INT: "TEQ",
          TEQ: "AGL",
        };

        const classMatch = allyClass === enemyClass ? "same" : "opposite";
        let typeMatch = "neutral";
        if (allyType !== enemyType) {
          if (typeOrder[allyType] === enemyType) {
            typeMatch = "advantage";
          } else if (typeOrder[enemyType] === allyType) {
            typeMatch = "disadvantage";
          }
        }

        //Base
        const base = enemyAtk;
        const maxVariance = Math.max(1, variance);

        const computeRange = (saMulti, specificDRValue) => {
          //Applying super attack multipler and if attack was reduced by your character performing super attacks
          const saAfterDown = Math.max(0, saMulti - atkDownSa + atkBuff + externalAtk);

          //Applying all variations of attack-lowering effects
          const afterAtkDowns = base * saAfterDown * (1 - atkDownItem) * (1 - atkDownPassive);

          //Applying damage reduction variants
          const afterDr = afterAtkDowns * (1 - damageReduction) * (1 - specificDRValue);

          const { typeMultiplier, guardMultiplier } = getTypeAndGuardMultipliers(
            classMatch,
            typeMatch,
            passiveGuard
          );

          //Applying the effect of the type advantage/disadvantage, as well as finding the range of damage taken
          const minAfterType = afterDr * typeMultiplier;
          const maxAfterType = afterDr * typeMultiplier * maxVariance;

          //Finally accounting for defense and guard of the unit
          const buffedDefense = defense * (1 + defBuff);
          const minDamage = Math.max(0, (minAfterType - buffedDefense) * guardMultiplier);
          const maxDamage = Math.max(0, (maxAfterType - buffedDefense) * guardMultiplier);

          //Output text

            //In the game, if damage ammounts to 0, game chooses a number from 9 to 132
          if (maxDamage === 0) {
            return "9 - 132";
          }

          const minText = Math.round(minDamage).toLocaleString();
          const maxText = Math.round(maxDamage).toLocaleString();
          return `${minText} - ${maxText}`;
        };
        //Super attacks use the multiplier and DR vs Supers
        superResult.textContent = computeRange(saMultiplier, drSupers);
        //Normal attacks don't use the multiplier but use DR vs Normals
        normalResult.textContent = computeRange(1, drNormals);

      };

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        calculateDamage();
      });

      resetBtn.addEventListener("click", () => {
        form.reset();
        superResult.textContent = "0";
        normalResult.textContent = "0";
      });

      presetButtons.forEach((button) => {
        button.addEventListener("click", () => {
          applyEnemyPreset(button.dataset.preset);
          const dropdown = button.closest("details");
          if (dropdown) dropdown.open = false;
        });
      });
      // its not committing right again
    </script>
  </body>
</html>
